<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Echo Shift 3D — Hard Mode Arena (Enhanced)</title>
<style>
  body { margin:0; overflow:hidden; background:black; font-family:system-ui; color:white; }
  #ui { position:fixed; top:10px; left:50%; transform:translateX(-50%); display:flex; gap:20px; font-size:14px; z-index:10; }
  #overlay { position:fixed; top:0; left:0; width:100%; height:100%; display:none; justify-content:center; align-items:center; background: rgba(0,0,0,0.85); color:white; flex-direction:column; text-align:center; z-index:20;}
  #overlay h1 { font-size:48px; margin:0 0 20px 0; }
  #overlay p,#overlay div { font-size:22px; margin:5px 0; }
</style>
</head>
<body>
<div id="ui">
  <div id="score">Score: 0</div>
  <div id="status">SAFE</div>
  <div>R = Rewind</div>
</div>
<div id="overlay">
  <h1>GAME OVER</h1>
  <p id="finalScore">Score: 0</p>
  <div id="leaderboard"></div>
  <p>Refresh to retry</p>
</div>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";

/* ---------- LEADERBOARD ---------- */
const LB_KEY = "echo_shift_leaderboard";
function loadLeaderboard(){ return JSON.parse(localStorage.getItem(LB_KEY)||"[]"); }
function saveScore(score){ let lb=loadLeaderboard(); lb.push(Math.floor(score)); lb.sort((a,b)=>b-a); lb=lb.slice(0,5); localStorage.setItem(LB_KEY,JSON.stringify(lb)); return lb; }

/* ---------- SCENE ---------- */
const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x000000,20,80);

/* ---------- CAMERA ---------- */
const camera = new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,200);
camera.position.set(0,35,40);
camera.lookAt(0,0,0);

/* ---------- RENDERER ---------- */
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

/* ---------- LIGHT ---------- */
scene.add(new THREE.AmbientLight(0x404040));
const light = new THREE.PointLight(0x00ffff,1.2,100);
light.position.set(0,30,20);
scene.add(light);

/* ---------- FLOOR ---------- */
const floorGeo = new THREE.PlaneGeometry(50,50);
const floorMat = new THREE.MeshStandardMaterial({color:0x111111, side:THREE.DoubleSide});
const floor = new THREE.Mesh(floorGeo,floorMat);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

/* ---------- WALLS ---------- */
const wallGeo = new THREE.BoxGeometry(50,5,0.5);
const wallMat = new THREE.MeshStandardMaterial({color:0x333333});
const walls = [];
const wallPositions = [
  {x:0,z:25}, {x:0,z:-25}, {x:25,z:0,rotY:Math.PI/2}, {x:-25,z:0,rotY:Math.PI/2}
];
wallPositions.forEach(pos=>{
  const wall = new THREE.Mesh(wallGeo, wallMat);
  wall.position.set(pos.x,2.5,pos.z);
  if(pos.rotY) wall.rotation.y = pos.rotY;
  scene.add(wall);
  walls.push(wall);
});

/* ---------- INPUT ---------- */
const keys = {};
addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

/* ---------- PLAYER ---------- */
const playerGeo = new THREE.SphereGeometry(1,32,32);
const playerMat = new THREE.MeshStandardMaterial({color:0x00ffcc,emissive:0x00ffcc,emissiveIntensity:0.6});
const player = new THREE.Mesh(playerGeo,playerMat);
scene.add(player);

/* ---------- GAME STATE ---------- */
let shards=[];
let echoes=[];
let timeline=[];
let score=0;
let alive=true;
let grace=120;
let tick=0;
const LIMIT=24;

const overlay=document.getElementById("overlay");
const finalScore=document.getElementById("finalScore");
const lbDiv=document.getElementById("leaderboard");

/* ---------- SHARDS ---------- */
function spawnShard(){
  const angle=Math.random()*Math.PI*2;
  const geo=new THREE.SphereGeometry(1.2,16,16); // bigger shard
  const mat=new THREE.MeshStandardMaterial({
    color:0xff6666, // slightly brighter
    emissive:0xff0000,
    emissiveIntensity:1.8 // stronger glow
  });
  const mesh=new THREE.Mesh(geo,mat);
  mesh.position.set(0,0,0);
  scene.add(mesh);
  shards.push({mesh,vel:new THREE.Vector3(Math.cos(angle),0,Math.sin(angle)).multiplyScalar(0.4)});
}

/* ---------- REWIND ---------- */
function rewind(){
  if(timeline.length<60) return;
  echoes.push({path:[...timeline],t:0,mesh:createEchoMesh()});
  timeline=[];
  player.position.set(0,0,0);
  grace=120;
  score+=400;
}

function createEchoMesh(){
  const geo=new THREE.SphereGeometry(1,16,16);
  const mat=new THREE.MeshStandardMaterial({color:0x3399ff,transparent:true,opacity:0.35});
  const m=new THREE.Mesh(geo,mat);
  scene.add(m);
  return m;
}

/* ---------- UPDATE ---------- */
function update(){
  if(!alive) return;

  if(keys["r"]){keys["r"]=false; rewind();}

  const speed=0.4;
  if(keys["w"]||keys["arrowup"]) player.position.z-=speed;
  if(keys["s"]||keys["arrowdown"]) player.position.z+=speed;
  if(keys["a"]||keys["arrowleft"]) player.position.x-=speed;
  if(keys["d"]||keys["arrowright"]) player.position.x+=speed;

  // BOUNDARIES
  player.position.x=Math.max(-LIMIT,Math.min(LIMIT,player.position.x));
  player.position.z=Math.max(-LIMIT,Math.min(LIMIT,player.position.z));

  timeline.push(player.position.clone());
  if(timeline.length>600) timeline.shift();

  // SPAWN SHARDS — harder over time
  const spawnRate = Math.max(5, 30 - Math.floor(score/500));
  if(tick % spawnRate === 0){
    const shardCount = Math.min(3,1 + Math.floor(score/1000));
    for(let i=0;i<shardCount;i++) spawnShard();
  }

  // SHARD MOVEMENT & COLLISION
  shards = shards.filter(s=>{
    s.mesh.position.add(s.vel.multiplyScalar(1 + score/5000));

    for(const e of echoes){
      const echoRadius = Math.max(2.5,3.5 - score/1000);
      if(e.t<e.path.length && s.mesh.position.distanceTo(e.path[e.t])<echoRadius){
        scene.remove(s.mesh);
        return false; // destroyed by echo
      }
    }

    if(grace<=0 && s.mesh.position.distanceTo(player.position)<1.2){
      alive=false;
      showGameOver();
    }
    return true;
  });

  // ECHO MOVEMENT
  echoes.forEach(e=>{ if(e.t<e.path.length) e.mesh.position.copy(e.path[e.t]); e.t++; });

  score++;
  document.getElementById("score").textContent="Score: "+score;
  document.getElementById("status").textContent=grace>0?"SAFE":"DANGER";

  grace--;
  tick++;
}

/* ---------- GAME OVER ---------- */
function showGameOver(){
  overlay.style.display="flex";
  finalScore.textContent="Score: "+score;
  const lb=saveScore(score);
  lbDiv.innerHTML="<strong>Leaderboard:</strong><br>"+lb.map((s,i)=>`#${i+1} - ${s}`).join("<br>");
}

/* ---------- ANIMATE ---------- */
function animate(){update(); renderer.render(scene,camera); requestAnimationFrame(animate);}
animate();

/* ---------- RESIZE ---------- */
addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
