<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Echo Shift: Echo Defense</title>
<style>
  body {
    margin: 0;
    background: radial-gradient(#050505, #000);
    overflow: hidden;
    font-family: system-ui;
    color: white;
  }
  canvas {
    display: block;
    margin: auto;
    background: #000;
  }
  #ui {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 14px;
    opacity: 0.9;
    display: flex;
    gap: 20px;
  }
</style>
</head>
<body>
<div id="ui">
  <div id="score">Score: 0</div>
  <div id="status">SAFE</div>
  <div>R = Rewind</div>
</div>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

const keys = {};
addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

const player = { x: canvas.width/2, y: canvas.height/2, r: 10 };
let shards = [];
let echoes = [];
let timeline = [];
let tick = 0;
let alive = true;
let score = 0;
let shake = 0;
let grace = 120;

const ECHO_RADIUS = 55;

function spawnShard() {
  const angle = Math.random() * Math.PI * 2;
  shards.push({
    x: canvas.width/2,
    y: canvas.height/2,
    z: 1,
    vx: Math.cos(angle),
    vy: Math.sin(angle)
  });
}

function rewind() {
  if (timeline.length < 60) return;
  echoes.push({ path: [...timeline], t: 0 });
  timeline = [];
  player.x = canvas.width / 2;
  player.y = canvas.height / 2;
  score += 500;
  shake = 10;
  grace = 120;
}

function update() {
  if (!alive) return;

  if (keys["r"]) {
    keys["r"] = false;
    rewind();
  }

  const speed = 4;
  if (keys["w"] || keys["arrowup"]) player.y -= speed;
  if (keys["s"] || keys["arrowdown"]) player.y += speed;
  if (keys["a"] || keys["arrowleft"]) player.x -= speed;
  if (keys["d"] || keys["arrowright"]) player.x += speed;

  player.x = Math.max(0, Math.min(canvas.width, player.x));
  player.y = Math.max(0, Math.min(canvas.height, player.y));

  timeline.push({ x: player.x, y: player.y });
  if (timeline.length > 600) timeline.shift();

  if (tick % 25 === 0) spawnShard();

  shards = shards.filter(s => {
    s.z -= 0.02;
    s.x += s.vx * 8;
    s.y += s.vy * 8;
    return s.z > 0;
  });

  echoes.forEach(e => {
    if (e.t < e.path.length) {
      const p = e.path[e.t];

      shards = shards.filter(s => {
        const scale = 1 / s.z;
        const sx = (s.x - canvas.width/2) * scale + canvas.width/2;
        const sy = (s.y - canvas.height/2) * scale + canvas.height/2;
        return Math.hypot(sx - p.x, sy - p.y) > ECHO_RADIUS;
      });

      if (grace <= 0 && Math.hypot(p.x - player.x, p.y - player.y) < player.r * 2) {
        alive = false;
        shake = 20;
      }

      e.t++;
    }
  });

  shards.forEach(s => {
    const scale = 1 / s.z;
    const sx = (s.x - canvas.width/2) * scale + canvas.width/2;
    const sy = (s.y - canvas.height/2) * scale + canvas.height/2;
    const r = 6 * scale;

    if (grace <= 0 && Math.hypot(sx - player.x, sy - player.y) < r + player.r) {
      alive = false;
      shake = 20;
    }
  });

  score += 1 + echoes.length * 0.75;
  document.getElementById("score").textContent = "Score: " + Math.floor(score);
  document.getElementById("status").textContent = grace > 0 ? "SAFE" : "DANGER";

  grace--;
  tick++;
  shake *= 0.9;
}

function draw() {
  ctx.save();
  ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake);

  ctx.fillStyle = "rgba(0,0,0,0.35)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  shards.forEach(s => {
    const scale = 1 / s.z;
    const x = (s.x - canvas.width/2) * scale + canvas.width/2;
    const y = (s.y - canvas.height/2) * scale + canvas.height/2;
    const r = 6 * scale;
    ctx.fillStyle = "rgba(255,80,80,0.9)";
    ctx.beginPath();
    ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fill();
  });

  echoes.forEach(e => {
    if (e.t < e.path.length) {
      const p = e.path[e.t];
      ctx.strokeStyle = "rgba(0,150,255,0.15)";
      ctx.beginPath();
      ctx.arc(p.x, p.y, ECHO_RADIUS, 0, Math.PI*2);
      ctx.stroke();

      ctx.fillStyle = "rgba(0,150,255,0.35)";
      ctx.beginPath();
      ctx.arc(p.x, p.y, player.r, 0, Math.PI*2);
      ctx.fill();
    }
  });

  ctx.fillStyle = grace > 0 ? "#ffff66" : "#00ffcc";
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
  ctx.fill();

  if (!alive) {
    ctx.fillStyle = "rgba(0,0,0,0.6)";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle = "white";
    ctx.textAlign = "center";
    ctx.font = "48px system-ui";
    ctx.fillText("REALITY FAILED", canvas.width/2, canvas.height/2 - 40);

    ctx.font = "24px system-ui";
    ctx.fillText("Final Score: " + Math.floor(score), canvas.width/2, canvas.height/2 + 10);

    ctx.font = "16px system-ui";
    ctx.fillText("Refresh to retry", canvas.width/2, canvas.height/2 + 45);
  }

  ctx.restore();
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
