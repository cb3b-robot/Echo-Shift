<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Echo Shift</title>
<style>
  body {
    margin: 0;
    background: radial-gradient(#050505, #000);
    overflow: hidden;
    font-family: system-ui;
    color: white;
  }
  canvas {
    display: block;
    margin: auto;
    background: #000;
  }
  #ui {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 14px;
    opacity: 0.85;
  }
</style>
</head>
<body>
<div id="ui">Move • R = Rewind • Survive your echoes</div>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

const keys = {};
addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

const player = { x: canvas.width/2, y: canvas.height/2, r: 10 };
let shards = [];
let echoes = [];
let timeline = [];
let tick = 0;
let alive = true;

function spawnShard() {
  const side = Math.floor(Math.random()*4);
  const s = { x:0, y:0, vx:0, vy:0, r:6 };
  if (side === 0) { s.x = Math.random()*canvas.width; s.y = -10; s.vy = 3; }
  if (side === 1) { s.x = canvas.width+10; s.y = Math.random()*canvas.height; s.vx = -3; }
  if (side === 2) { s.x = Math.random()*canvas.width; s.y = canvas.height+10; s.vy = -3; }
  if (side === 3) { s.x = -10; s.y = Math.random()*canvas.height; s.vx = 3; }
  shards.push(s);
}

function rewind() {
  if (timeline.length < 30) return;
  echoes.push([...timeline]);
  timeline = [];
  player.x = canvas.width/2;
  player.y = canvas.height/2;
}

function update() {
  if (!alive) return;

  if (keys["r"]) {
    keys["r"] = false;
    rewind();
  }

  const speed = 4;
  if (keys["w"] || keys["arrowup"]) player.y -= speed;
  if (keys["s"] || keys["arrowdown"]) player.y += speed;
  if (keys["a"] || keys["arrowleft"]) player.x -= speed;
  if (keys["d"] || keys["arrowright"]) player.x += speed;

  player.x = Math.max(0, Math.min(canvas.width, player.x));
  player.y = Math.max(0, Math.min(canvas.height, player.y));

  timeline.push({ x: player.x, y: player.y });
  if (timeline.length > 600) timeline.shift();

  if (tick % 40 === 0) spawnShard();

  shards.forEach(s => {
    s.x += s.vx;
    s.y += s.vy;
    if (Math.hypot(s.x-player.x, s.y-player.y) < s.r + player.r) alive = false;
  });

  echoes.forEach(e => {
    if (tick < e.length) {
      const p = e[tick];
      if (Math.hypot(p.x-player.x, p.y-player.y) < player.r*2) alive = false;
    }
  });

  tick++;
}

function draw() {
  ctx.fillStyle = "rgba(0,0,0,0.3)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  shards.forEach(s => {
    ctx.fillStyle = "#ff4d4d";
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
    ctx.fill();
  });

  echoes.forEach(e => {
    if (tick < e.length) {
      ctx.fillStyle = "rgba(0,150,255,0.3)";
      ctx.beginPath();
      ctx.arc(e[tick].x, e[tick].y, player.r, 0, Math.PI*2);
      ctx.fill();
    }
  });

  ctx.fillStyle = alive ? "#00ffcc" : "#ff0000";
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
  ctx.fill();

  if (!alive) {
    ctx.fillStyle = "white";
    ctx.font = "40px system-ui";
    ctx.fillText("TIME COLLAPSED", canvas.width/2-140, canvas.height/2);
  }
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
