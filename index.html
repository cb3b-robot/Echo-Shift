<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Echo Shift: Hard Mode</title>
<style>
  body {
    margin: 0;
    background: radial-gradient(#050505, #000);
    overflow: hidden;
    font-family: system-ui;
    color: white;
  }
  canvas {
    display: block;
    margin: auto;
    background: #000;
  }
  #ui {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 14px;
    opacity: 0.9;
    display: flex;
    gap: 20px;
  }
</style>
</head>
<body>
<div id="ui">
  <div id="score">Score: 0</div>
  <div id="status">SAFE</div>
  <div>R = Rewind</div>
</div>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

/* ---------- LEADERBOARD ---------- */
const LB_KEY = "echo_shift_leaderboard";
function loadLeaderboard() {
  return JSON.parse(localStorage.getItem(LB_KEY) || "[]");
}
function saveScore(score) {
  let lb = loadLeaderboard();
  lb.push(Math.floor(score));
  lb.sort((a,b)=>b-a);
  lb = lb.slice(0,5);
  localStorage.setItem(LB_KEY, JSON.stringify(lb));
  return lb;
}
/* --------------------------------- */

const keys = {};
addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

const player = { x: canvas.width/2, y: canvas.height/2, r: 10 };
let shards = [];
let echoes = [];
let timeline = [];
let tick = 0;
let alive = true;
let score = 0;
let shake = 0;
let grace = 120;
let leaderboard = loadLeaderboard();
let scoreSaved = false;

const BASE_ECHO_RADIUS = 60;

function difficulty() {
  return Math.min(1 + score / 1500, 4);
}

function spawnShard() {
  const angle = Math.random() * Math.PI * 2;
  const d = difficulty();
  shards.push({
    x: canvas.width/2,
    y: canvas.height/2,
    z: 1,
    vx: Math.cos(angle),
    vy: Math.sin(angle),
    speed: 6 + d * 1.5
  });
}

function rewind() {
  if (timeline.length < 60) return;
  echoes.push({ path: [...timeline], t: 0 });
  timeline = [];
  player.x = canvas.width / 2;
  player.y = canvas.height / 2;
  score += 400;
  shake = 10;
  grace = Math.max(30, grace - 10); // grace decays over time
}

function update() {
  if (!alive) {
    if (!scoreSaved) {
      leaderboard = saveScore(score);
      scoreSaved = true;
    }
    return;
  }

  if (keys["r"]) {
    keys["r"] = false;
    rewind();
  }

  const speed = 4.2;
  if (keys["w"] || keys["arrowup"]) player.y -= speed;
  if (keys["s"] || keys["arrowdown"]) player.y += speed;
  if (keys["a"] || keys["arrowleft"]) player.x -= speed;
  if (keys["d"] || keys["arrowright"]) player.x += speed;

  player.x = Math.max(0, Math.min(canvas.width, player.x));
  player.y = Math.max(0, Math.min(canvas.height, player.y));

  timeline.push({ x: player.x, y: player.y });
  if (timeline.length > 600) timeline.shift();

  const spawnRate = Math.max(10, 30 - difficulty() * 5);
  if (tick % Math.floor(spawnRate) === 0) spawnShard();

  shards = shards.filter(s => {
    s.z -= 0.02;
    const dx = player.x - s.x;
    const dy = player.y - s.y;
    const steer = 0.002 * difficulty();
    s.vx += dx * steer;
    s.vy += dy * steer;

    const mag = Math.hypot(s.vx, s.vy);
    s.vx /= mag;
    s.vy /= mag;

    s.x += s.vx * s.speed;
    s.y += s.vy * s.speed;
    return s.z > 0;
  });

  echoes.forEach(e => {
    if (e.t < e.path.length) {
      const p = e.path[e.t];
      const radius = Math.max(25, BASE_ECHO_RADIUS - difficulty() * 8);

      shards = shards.filter(s => {
        const scale = 1 / s.z;
        const sx = (s.x - canvas.width/2) * scale + canvas.width/2;
        const sy = (s.y - canvas.height/2) * scale + canvas.height/2;
        return Math.hypot(sx - p.x, sy - p.y) > radius;
      });

      if (grace <= 0 && Math.hypot(p.x - player.x, p.y - player.y) < player.r * 2) {
        alive = false;
        shake = 20;
      }
      e.t++;
    }
  });

  shards.forEach(s => {
    const scale = 1 / s.z;
    const sx = (s.x - canvas.width/2) * scale + canvas.width/2;
    const sy = (s.y - canvas.height/2) * scale + canvas.height/2;
    const r = 6 * scale;

    if (grace <= 0 && Math.hypot(sx - player.x, sy - player.y) < r + player.r) {
      alive = false;
      shake = 20;
    }
  });

  score += 1 + difficulty();
  document.getElementById("score").textContent = "Score: " + Math.floor(score);
  document.getElementById("status").textContent = grace > 0 ? "SAFE" : "DANGER";

  grace--;
  tick++;
  shake *= 0.9;
}

function draw() {
  ctx.save();
  ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake);
  ctx.fillStyle = "rgba(0,0,0,0.4)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  shards.forEach(s => {
    const scale = 1 / s.z;
    const x = (s.x - canvas.width/2) * scale + canvas.width/2;
    const y = (s.y - canvas.height/2) * scale + canvas.height/2;
    ctx.fillStyle = "rgba(255,80,80,0.95)";
    ctx.beginPath();
    ctx.arc(x,y,6*scale,0,Math.PI*2);
    ctx.fill();
  });

  echoes.forEach(e => {
    if (e.t < e.path.length) {
      const p = e.path[e.t];
      const radius = Math.max(25, BASE_ECHO_RADIUS - difficulty() * 8);
      ctx.strokeStyle = "rgba(0,150,255,0.12)";
      ctx.beginPath();
      ctx.arc(p.x, p.y, radius, 0, Math.PI*2);
      ctx.stroke();
      ctx.fillStyle = "rgba(0,150,255,0.35)";
      ctx.beginPath();
      ctx.arc(p.x, p.y, player.r, 0, Math.PI*2);
      ctx.fill();
    }
  });

  ctx.fillStyle = grace > 0 ? "#ffee88" : "#00ffcc";
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
  ctx.fill();

  if (!alive) {
    ctx.fillStyle = "rgba(0,0,0,0.75)";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.textAlign = "center";
    ctx.fillStyle = "white";
    ctx.font = "48px system-ui";
    ctx.fillText("REALITY FAILED", canvas.width/2, canvas.height/2 - 120);

    ctx.font = "22px system-ui";
    ctx.fillText("Final Score: " + Math.floor(score), canvas.width/2, canvas.height/2 - 80);

    ctx.font = "20px system-ui";
    ctx.fillText("LEADERBOARD", canvas.width/2, canvas.height/2 - 30);

    ctx.font = "18px system-ui";
    leaderboard.forEach((s,i) => {
      ctx.fillText(`#${i+1}  ${s}`, canvas.width/2, canvas.height/2 + i*24);
    });

    ctx.font = "14px system-ui";
    ctx.fillText("Refresh to retry", canvas.width/2, canvas.height/2 + 140);
  }

  ctx.restore();
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
